<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©æµè¿è¥çœ‹æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }
        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filters input, .filters select, .filters button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .filters button {
            background: #1890ff;
            color: white;
            border: none;
            cursor: pointer;
        }
        .filters button:hover {
            background: #40a9ff;
        }
        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .kpi-card.normal { border-left: 4px solid #52c41a; }
        .kpi-card.warning { border-left: 4px solid #faad14; }
        .kpi-card.exception { border-left: 4px solid #f5222d; }
        .kpi-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        .charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chart-container canvas {
            max-height: 300px;
        }
        .tables-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .data-table {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #fafafa;
            font-weight: bold;
        }
        .status-normal { color: #52c41a; }
        .status-warning { color: #faad14; }
        .status-exception { color: #f5222d; }
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        /* æ–°å¢æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 90%;
            max-height: 80%;
            overflow: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .modal-title {
            color: #1890ff;
            font-size: 20px;
            font-weight: bold;
        }
        .close-btn {
            background: #f5222d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .close-btn:hover {
            background: #ff4d4f;
        }
        .site-link {
            color: #1890ff;
            text-decoration: none;
            cursor: pointer;
            font-weight: bold;
        }
        .site-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>ğŸšš ç‰©æµè¿è¥çœ‹æ¿</h1>
            <div class="filters">
                <input type="date" id="startDate">
                <input type="date" id="endDate">
                <select id="siteSelect">
                    <option value="">æ‰€æœ‰ç«™ç‚¹</option>
                </select>
                <button onclick="loadData()">æŸ¥è¯¢</button>
                <button onclick="generateReport()">ç”ŸæˆæŠ¥å‘Š</button>
            </div>
        </div>

        <div class="kpi-cards" id="kpiCards">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>

        <div class="charts">
            <div class="chart-container">
                <h3>å®Œæˆç‡ vs ETAè¾¾æˆç‡</h3>
                <canvas id="completionChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>æ‹’æ”¶ç‡è¶‹åŠ¿</h3>
                <canvas id="rejectionChart"></canvas>
            </div>
        </div>

        <div class="tables-container">
            <div class="data-table">
                <h3>ğŸ“Š ç«™ç‚¹æ€§èƒ½è¯¦æƒ… <span style="font-size: 12px; color: #666; font-weight: normal;">(ç‚¹å‡»ç«™ç‚¹åç§°æŸ¥çœ‹è¯¦æƒ…)</span></h3>
                <table id="siteTable">
                    <thead>
                        <tr>
                            <th>ç«™ç‚¹åç§°</th>
                            <th>å®Œæˆç‡</th>
                            <th>æ‹’æ”¶ç‡</th>
                            <th>å‡†æ—¶ç‡</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="siteTableBody">
                        <tr><td colspan="5" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="data-table">
                <h3>ğŸš´ é…é€å‘˜ç»©æ•ˆæ’å</h3>
                <table id="riderTable">
                    <thead>
                        <tr>
                            <th>é…é€å‘˜</th>
                            <th>å®Œæˆç‡</th>
                            <th>å‡†æ—¶ç‡</th>
                            <th>æ—¶å‡å•é‡</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="riderTableBody">
                        <tr><td colspan="5" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://oversilent-aswarm-vanna.ngrok-free.dev/api';
        let completionChart, rejectionChart;

        // åˆå§‹åŒ–æ—¥æœŸ
        function initDates() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);
            
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        }

        // åŠ è½½ç«™ç‚¹åˆ—è¡¨
        async function loadSitesList() {
            try {
                console.log('æ­£åœ¨åŠ è½½ç«™ç‚¹åˆ—è¡¨...');
                const response = await axios.get(`${API_BASE}/sites/list`);
                console.log('ç«™ç‚¹åˆ—è¡¨åŠ è½½æˆåŠŸ:', response.data);
                
                const siteSelect = document.getElementById('siteSelect');
                siteSelect.innerHTML = '<option value="">æ‰€æœ‰ç«™ç‚¹</option>';
                
                response.data.forEach(site => {
                    const option = document.createElement('option');
                    option.value = site.site_id;
                    option.textContent = `${site.site_name} (${site.manager})`;
                    siteSelect.appendChild(option);
                });
            } catch (error) {
                console.error('åŠ è½½ç«™ç‚¹åˆ—è¡¨å¤±è´¥:', error);
                alert('åŠ è½½ç«™ç‚¹åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const siteId = document.getElementById('siteSelect').value;

            console.log('å¼€å§‹åŠ è½½æ•°æ®:', { startDate, endDate, siteId });

            try {
                // åŠ è½½KPIæ•°æ®
                console.log('æ­£åœ¨åŠ è½½KPIæ•°æ®...');
                const kpiResponse = await axios.get(`${API_BASE}/kpi/daily`, {
                    params: { start_date: startDate, end_date: endDate, site_id: siteId }
                });
                console.log('KPIæ•°æ®åŠ è½½æˆåŠŸ:', kpiResponse.data);
                
                // åŠ è½½ç«™ç‚¹æ€§èƒ½æ•°æ®
                console.log('æ­£åœ¨åŠ è½½ç«™ç‚¹æ€§èƒ½æ•°æ®...');
                const siteResponse = await axios.get(`${API_BASE}/kpi/sites`, {
                    params: { date: endDate }
                });
                console.log('ç«™ç‚¹æ€§èƒ½æ•°æ®åŠ è½½æˆåŠŸ:', siteResponse.data);

                // åŠ è½½é…é€å‘˜ç»©æ•ˆæ•°æ®
                console.log('æ­£åœ¨åŠ è½½é…é€å‘˜æ•°æ®...');
                const riderResponse = await axios.get(`${API_BASE}/riders/performance`, {
                    params: { date: endDate, site_id: siteId }
                });
                console.log('é…é€å‘˜æ•°æ®åŠ è½½æˆåŠŸ:', riderResponse.data);

                updateKPICards(kpiResponse.data);
                updateCharts(kpiResponse.data);
                updateSiteTable(siteResponse.data);
                updateRiderTable(riderResponse.data);
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                alert('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨: ' + error.message);
            }
        }

        // æ›´æ–°KPIå¡ç‰‡
        function updateKPICards(data) {
            console.log('æ›´æ–°KPIå¡ç‰‡:', data);
            if (!data || data.length === 0) {
                document.getElementById('kpiCards').innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            const latestData = data[data.length - 1];
            const kpiCards = document.getElementById('kpiCards');
            
            const cards = [
                { 
                    title: 'å®Œæˆç‡', 
                    value: `${latestData.completion_rate}%`,
                    status: latestData.completion_rate >= 98 ? 'normal' : 
                           latestData.completion_rate >= 97 ? 'warning' : 'exception'
                },
                { 
                    title: 'æ‹’æ”¶ç‡', 
                    value: `${latestData.rejection_rate}%`,
                    status: latestData.rejection_rate <= 1.0 ? 'normal' : 
                           latestData.rejection_rate <= 1.5 ? 'warning' : 'exception'
                },
                { 
                    title: 'ETAè¾¾æˆç‡', 
                    value: `${latestData.eta_achievement_rate}%`,
                    status: latestData.eta_achievement_rate >= 96 ? 'normal' : 
                           latestData.eta_achievement_rate >= 94 ? 'warning' : 'exception'
                },
                { 
                    title: 'å•å‡æˆæœ¬', 
                    value: `Â¥${latestData.cost_per_order}`,
                    status: latestData.cost_per_order <= 8.0 ? 'normal' : 
                           latestData.cost_per_order <= 8.5 ? 'warning' : 'exception'
                }
            ];

            kpiCards.innerHTML = cards.map(card => `
                <div class="kpi-card ${card.status}">
                    <div class="kpi-title">${card.title}</div>
                    <div class="kpi-value">${card.value}</div>
                    <div class="kpi-status">${getStatusText(card.status)}</div>
                </div>
            `).join('');
        }

        function getStatusText(status) {
            const statusMap = {
                'normal': 'æ­£å¸¸',
                'warning': 'è­¦å‘Š', 
                'exception': 'å¼‚å¸¸'
            };
            return statusMap[status] || 'æœªçŸ¥';
        }

        function getRiderStatus(rider) {
            if (rider.completion_rate < 95 || rider.rejection_rate > 3) {
                return 'exception';
            } else if (rider.completion_rate < 97 || rider.rejection_rate > 2) {
                return 'warning';
            } else {
                return 'normal';
            }
        }

        // æ›´æ–°å›¾è¡¨
        function updateCharts(data) {
            console.log('æ›´æ–°å›¾è¡¨:', data);
            const dates = data.map(d => d.date);
            const completionRates = data.map(d => d.completion_rate);
            const etaRates = data.map(d => d.eta_achievement_rate);
            const rejectionRates = data.map(d => d.rejection_rate);

            // å®Œæˆç‡ vs ETAè¾¾æˆç‡å›¾è¡¨
            if (completionChart) completionChart.destroy();
            const completionCtx = document.getElementById('completionChart').getContext('2d');
            completionChart = new Chart(completionCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'å®Œæˆç‡',
                            data: completionRates,
                            borderColor: '#1890ff',
                            backgroundColor: 'rgba(24, 144, 255, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'ETAè¾¾æˆç‡',
                            data: etaRates,
                            borderColor: '#52c41a',
                            backgroundColor: 'rgba(82, 196, 26, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 90,
                            max: 100
                        }
                    }
                }
            });

            // æ‹’æ”¶ç‡å›¾è¡¨
            if (rejectionChart) rejectionChart.destroy();
            const rejectionCtx = document.getElementById('rejectionChart').getContext('2d');
            rejectionChart = new Chart(rejectionCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'æ‹’æ”¶ç‡',
                        data: rejectionRates,
                        borderColor: '#f5222d',
                        backgroundColor: 'rgba(245, 34, 45, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        // æ›´æ–°ç«™ç‚¹è¡¨æ ¼ - å·²æ·»åŠ è¶…é“¾æ¥
        function updateSiteTable(data) {
            console.log('æ›´æ–°ç«™ç‚¹è¡¨æ ¼:', data);
            const tbody = document.getElementById('siteTableBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">æš‚æ— ç«™ç‚¹æ•°æ®</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map(site => `
                <tr>
                    <td>
                        <a href="javascript:void(0)" 
                           onclick="showSiteDetail('${site.site_id}')" 
                           class="site-link">
                           ${site.site_id}
                        </a>
                    </td>
                    <td>${site.completion_rate}%</td>
                    <td>${site.rejection_rate}%</td>
                    <td>${site.eta_achievement_rate}%</td>
                    <td class="status-${site.status}">${getStatusText(site.status)}</td>
                </tr>
            `).join('');
        }

        // æ›´æ–°é…é€å‘˜è¡¨æ ¼
        function updateRiderTable(data) {
            console.log('æ›´æ–°é…é€å‘˜è¡¨æ ¼:', data);
            const tbody = document.getElementById('riderTableBody');
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">æš‚æ— é…é€å‘˜æ•°æ®</td></tr>';
                return;
            }
            
            // æŒ‰å®Œæˆç‡æ’åº
            const sortedData = data.sort((a, b) => b.completion_rate - a.completion_rate);
            
            tbody.innerHTML = sortedData.map(rider => {
                const status = getRiderStatus(rider);
                return `
                <tr>
                    <td>${rider.rider_name}</td>
                    <td>${rider.completion_rate}%</td>
                    <td>${rider.on_time_rate}%</td>
                    <td>${rider.orders_per_hour}</td>
                    <td class="status-${status}">${getStatusText(status)}</td>
                </tr>
                `;
            }).join('');
        }

        // æ–°å¢ï¼šæ˜¾ç¤ºç«™ç‚¹è¯¦æƒ…åŠŸèƒ½
        function showSiteDetail(siteId) {
            const endDate = document.getElementById('endDate').value;
            
            // è·å–è¯¥ç«™ç‚¹çš„é…é€å‘˜æ•°æ®
            axios.get(`${API_BASE}/riders/performance`, {
                params: { date: endDate, site_id: siteId }
            }).then(response => {
                const riders = response.data;
                
                // åˆ›å»ºè¯¦æƒ…å†…å®¹
                let detailHtml = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ğŸ“ ç«™ç‚¹ ${siteId} è¯¦ç»†æ•°æ®</div>
                            <button class="close-btn" onclick="closeModal()">å…³é—­</button>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                <thead>
                                    <tr style="background: #f5f5f5;">
                                        <th style="padding: 12px; border: 1px solid #ddd; text-align: left;">é…é€å‘˜</th>
                                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">å®Œæˆç‡</th>
                                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">å‡†æ—¶ç‡</th>
                                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">æ—¶å‡å•é‡</th>
                                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">å•å‡æˆæœ¬</th>
                                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">æ€»è®¢å•</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                riders.forEach(rider => {
                    const status = getRiderStatus(rider);
                    const completionColor = rider.completion_rate >= 95 ? '#52c41a' : '#f5222d';
                    detailHtml += `
                        <tr>
                            <td style="padding: 10px; border: 1px solid #ddd;">${rider.rider_name}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: ${completionColor}">${rider.completion_rate}%</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${rider.on_time_rate}%</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${rider.orders_per_hour}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">$${rider.cost_per_order}</td>
                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${rider.total_orders}</td>
                        </tr>
                    `;
                });
                
                detailHtml += `
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 20px; text-align: center; color: #666; font-size: 12px;">
                            å…± ${riders.length} åé…é€å‘˜
                        </div>
                    </div>
                `;
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                showModal(detailHtml);
            }).catch(error => {
                console.error('è·å–ç«™ç‚¹è¯¦æƒ…å¤±è´¥:', error);
                alert('è·å–ç«™ç‚¹è¯¦æƒ…å¤±è´¥: ' + error.message);
            });
        }

        // æ–°å¢ï¼šæ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(content) {
            // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
            const existingModal = document.getElementById('detailModal');
            if (existingModal) {
                document.body.removeChild(existingModal);
            }
            
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.id = 'detailModal';
            modal.className = 'modal';
            modal.innerHTML = content;
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }

        // æ–°å¢ï¼šå…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            const modal = document.getElementById('detailModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // ç”ŸæˆæŠ¥å‘Š
        async function generateReport() {
            alert('æŠ¥å‘Šç”ŸæˆåŠŸèƒ½å¼€å‘ä¸­...');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            initDates();
            loadSitesList();
            // å»¶è¿ŸåŠ è½½æ•°æ®ï¼Œç¡®ä¿ç«™ç‚¹åˆ—è¡¨å…ˆåŠ è½½å®Œæˆ
            setTimeout(() => {
                loadData();
            }, 100);
        };
    </script>
</body>
</html>