<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©æµè¿è¥çœ‹æ¿ - åœ¨çº¿æ¼”ç¤º</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', sans-serif; background-color: #f5f5f5; padding: 20px; }
        .dashboard { max-width: 1400px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .filters { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filters input, .filters select, .filters button { padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; }
        .filters button { background: #1890ff; color: white; border: none; cursor: pointer; }
        .filters button:hover { background: #40a9ff; }
        .kpi-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .kpi-card.normal { border-left: 4px solid #52c41a; }
        .kpi-card.warning { border-left: 4px solid #faad14; }
        .kpi-card.exception { border-left: 4px solid #f5222d; }
        .kpi-value { font-size: 24px; font-weight: bold; margin: 10px 0; }
        .charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .chart-container canvas { max-height: 300px; }
        .tables-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .data-table { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #fafafa; font-weight: bold; }
        .status-normal { color: #52c41a; }
        .status-warning { color: #faad14; }
        .status-exception { color: #f5222d; }
        .loading { text-align: center; color: #666; padding: 20px; }
        .site-link { color: #1890ff; text-decoration: none; cursor: pointer; font-weight: bold; }
        .site-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>ğŸšš ç¾å›½ç‰©æµè¿è¥çœ‹æ¿ - åœ¨çº¿æ¼”ç¤º</h1>
            <div class="filters">
                <input type="date" id="startDate">
                <input type="date" id="endDate">
                <select id="siteSelect">
                    <option value="">æ‰€æœ‰ç«™ç‚¹</option>
                </select>
                <button onclick="loadData()">æŸ¥è¯¢</button>
                <button onclick="showTechStack()">æŠ€æœ¯æ ˆ</button>
            </div>
        </div>

        <div class="kpi-cards" id="kpiCards">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>

        <div class="charts">
            <div class="chart-container">
                <h3>å®Œæˆç‡ vs ETAè¾¾æˆç‡</h3>
                <canvas id="completionChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>æ‹’æ”¶ç‡è¶‹åŠ¿</h3>
                <canvas id="rejectionChart"></canvas>
            </div>
        </div>

        <div class="tables-container">
            <div class="data-table">
                <h3>ğŸ“Š ç«™ç‚¹æ€§èƒ½è¯¦æƒ… <small>(ç‚¹å‡»ç«™ç‚¹æŸ¥çœ‹è¯¦æƒ…)</small></h3>
                <table id="siteTable">
                    <thead>
                        <tr>
                            <th>ç«™ç‚¹åç§°</th>
                            <th>å®Œæˆç‡</th>
                            <th>æ‹’æ”¶ç‡</th>
                            <th>å‡†æ—¶ç‡</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="siteTableBody">
                        <tr><td colspan="5" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="data-table">
                <h3>ğŸš´ é…é€å‘˜ç»©æ•ˆæ’å</h3>
                <table id="riderTable">
                    <thead>
                        <tr>
                            <th>é…é€å‘˜</th>
                            <th>å®Œæˆç‡</th>
                            <th>å‡†æ—¶ç‡</th>
                            <th>æ—¶å‡å•é‡</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="riderTableBody">
                        <tr><td colspan="5" class="loading">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œé¿å…CORSé—®é¢˜
        const mockData = {
            sites: [
                { site_id: 'site_la', site_name: 'æ´›æ‰çŸ¶å¸‚ä¸­å¿ƒç«™', manager: 'John Smith', region: 'åŠ å·' },
                { site_id: 'site_ny', site_name: 'çº½çº¦æ›¼å“ˆé¡¿ç«™', manager: 'Mike Johnson', region: 'çº½çº¦' },
                { site_id: 'site_sf', site_name: 'æ—§é‡‘å±±ç«™', manager: 'David Wilson', region: 'åŠ å·' },
                { site_id: 'site_chi', site_name: 'èŠåŠ å“¥ç«™', manager: 'Robert Brown', region: 'ä¼Šåˆ©è¯ºä¼Š' },
                { site_id: 'site_mia', site_name: 'è¿ˆé˜¿å¯†ç«™', manager: 'James Davis', region: 'ä½›ç½—é‡Œè¾¾' },
                { site_id: 'site_sea', site_name: 'è¥¿é›…å›¾ç«™', manager: 'William Miller', region: 'åç››é¡¿' }
            ],
            kpi: [
                { date: '2025-01-28', completion_rate: 95.5, rejection_rate: 1.2, eta_achievement_rate: 92.3, cost_per_order: 8.5 },
                { date: '2025-01-27', completion_rate: 96.1, rejection_rate: 0.8, eta_achievement_rate: 93.7, cost_per_order: 8.2 },
                { date: '2025-01-26', completion_rate: 94.8, rejection_rate: 1.5, eta_achievement_rate: 91.8, cost_per_order: 8.7 }
            ],
            sitePerformance: [
                { site_id: 'site_la', completion_rate: 96.2, rejection_rate: 0.9, eta_achievement_rate: 93.5, status: 'normal' },
                { site_id: 'site_ny', completion_rate: 95.8, rejection_rate: 1.1, eta_achievement_rate: 92.8, status: 'normal' },
                { site_id: 'site_sf', completion_rate: 97.1, rejection_rate: 0.7, eta_achievement_rate: 94.2, status: 'normal' },
                { site_id: 'site_chi', completion_rate: 94.5, rejection_rate: 1.8, eta_achievement_rate: 90.3, status: 'warning' },
                { site_id: 'site_mia', completion_rate: 93.2, rejection_rate: 2.3, eta_achievement_rate: 89.7, status: 'warning' },
                { site_id: 'site_sea', completion_rate: 96.7, rejection_rate: 0.6, eta_achievement_rate: 93.9, status: 'normal' }
            ],
            riders: [
                { rider_name: 'Rider_LA01-John', completion_rate: 97.5, on_time_rate: 94.2, orders_per_hour: 5.8, total_orders: 45, cost_per_order: 7.8 },
                { rider_name: 'Rider_NY01-Robert', completion_rate: 96.8, on_time_rate: 93.7, orders_per_hour: 6.2, total_orders: 52, cost_per_order: 8.1 },
                { rider_name: 'Rider_SF01-Chris', completion_rate: 98.1, on_time_rate: 95.3, orders_per_hour: 5.9, total_orders: 48, cost_per_order: 7.5 },
                { rider_name: 'Rider_CHI01-Steve', completion_rate: 94.2, on_time_rate: 89.8, orders_per_hour: 4.8, total_orders: 38, cost_per_order: 9.2 },
                { rider_name: 'Rider_MIA01-Daniel', completion_rate: 93.7, on_time_rate: 88.5, orders_per_hour: 4.5, total_orders: 36, cost_per_order: 9.5 },
                { rider_name: 'Rider_SEA01-Ryan', completion_rate: 96.3, on_time_rate: 92.9, orders_per_hour: 5.6, total_orders: 44, cost_per_order: 8.3 }
            ]
        };

        let completionChart, rejectionChart;

        // åˆå§‹åŒ–æ—¥æœŸ
        function initDates() {
            const endDate = '2025-01-28';
            const startDate = '2025-01-26';
            
            document.getElementById('startDate').value = startDate;
            document.getElementById('endDate').value = endDate;
        }

        // åŠ è½½ç«™ç‚¹åˆ—è¡¨
        function loadSitesList() {
            console.log('åŠ è½½æ¨¡æ‹Ÿç«™ç‚¹æ•°æ®...');
            const siteSelect = document.getElementById('siteSelect');
            siteSelect.innerHTML = '<option value="">æ‰€æœ‰ç«™ç‚¹</option>';
            
            mockData.sites.forEach(site => {
                const option = document.createElement('option');
                option.value = site.site_id;
                option.textContent = `${site.site_name} (${site.manager})`;
                siteSelect.appendChild(option);
            });
        }

        // åŠ è½½æ•°æ®
        function loadData() {
            console.log('åŠ è½½æ¨¡æ‹Ÿæ•°æ®...');
            
            // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            updateKPICards(mockData.kpi);
            updateCharts(mockData.kpi);
            updateSiteTable(mockData.sitePerformance);
            updateRiderTable(mockData.riders);
        }

        // æ›´æ–°KPIå¡ç‰‡
        function updateKPICards(data) {
            console.log('æ›´æ–°KPIå¡ç‰‡:', data);
            if (!data || data.length === 0) {
                document.getElementById('kpiCards').innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
                return;
            }
            
            const latestData = data[data.length - 1];
            const kpiCards = document.getElementById('kpiCards');
            
            const cards = [
                { 
                    title: 'å®Œæˆç‡', 
                    value: `${latestData.completion_rate}%`,
                    status: latestData.completion_rate >= 95 ? 'normal' : 'warning'
                },
                { 
                    title: 'æ‹’æ”¶ç‡', 
                    value: `${latestData.rejection_rate}%`,
                    status: latestData.rejection_rate <= 1.5 ? 'normal' : 'warning'
                },
                { 
                    title: 'å‡†æ—¶ç‡', 
                    value: `${latestData.eta_achievement_rate}%`,
                    status: latestData.eta_achievement_rate >= 92 ? 'normal' : 'warning'
                },
                { 
                    title: 'å•å‡æˆæœ¬', 
                    value: `$${latestData.cost_per_order}`,
                    status: latestData.cost_per_order <= 9.0 ? 'normal' : 'warning'
                }
            ];

            kpiCards.innerHTML = cards.map(card => `
                <div class="kpi-card ${card.status}">
                    <div class="kpi-title">${card.title}</div>
                    <div class="kpi-value">${card.value}</div>
                    <div class="kpi-status">${getStatusText(card.status)}</div>
                </div>
            `).join('');
        }

        function getStatusText(status) {
            const statusMap = { 'normal': 'æ­£å¸¸', 'warning': 'è­¦å‘Š', 'exception': 'å¼‚å¸¸' };
            return statusMap[status] || 'æœªçŸ¥';
        }

        function getRiderStatus(rider) {
            if (rider.completion_rate < 95 || rider.orders_per_hour < 4) return 'warning';
            return 'normal';
        }

        // æ›´æ–°å›¾è¡¨
        function updateCharts(data) {
            const dates = data.map(d => d.date);
            const completionRates = data.map(d => d.completion_rate);
            const etaRates = data.map(d => d.eta_achievement_rate);
            const rejectionRates = data.map(d => d.rejection_rate);

            // å®Œæˆç‡ vs ETAè¾¾æˆç‡å›¾è¡¨
            if (completionChart) completionChart.destroy();
            const completionCtx = document.getElementById('completionChart').getContext('2d');
            completionChart = new Chart(completionCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'å®Œæˆç‡',
                            data: completionRates,
                            borderColor: '#1890ff',
                            backgroundColor: 'rgba(24, 144, 255, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'å‡†æ—¶ç‡',
                            data: etaRates,
                            borderColor: '#52c41a',
                            backgroundColor: 'rgba(82, 196, 26, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: { responsive: true }
            });

            // æ‹’æ”¶ç‡å›¾è¡¨
            if (rejectionChart) rejectionChart.destroy();
            const rejectionCtx = document.getElementById('rejectionChart').getContext('2d');
            rejectionChart = new Chart(rejectionCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'æ‹’æ”¶ç‡',
                        data: rejectionRates,
                        borderColor: '#f5222d',
                        backgroundColor: 'rgba(245, 34, 45, 0.1)',
                        tension: 0.4
                    }]
                },
                options: { responsive: true }
            });
        }

        // æ›´æ–°ç«™ç‚¹è¡¨æ ¼
        function updateSiteTable(data) {
            const tbody = document.getElementById('siteTableBody');
            tbody.innerHTML = data.map(site => `
                <tr>
                    <td><a href="javascript:void(0)" onclick="showSiteDetail('${site.site_id}')" class="site-link">${site.site_id}</a></td>
                    <td>${site.completion_rate}%</td>
                    <td>${site.rejection_rate}%</td>
                    <td>${site.eta_achievement_rate}%</td>
                    <td class="status-${site.status}">${getStatusText(site.status)}</td>
                </tr>
            `).join('');
        }

        // æ›´æ–°é…é€å‘˜è¡¨æ ¼
        function updateRiderTable(data) {
            const tbody = document.getElementById('riderTableBody');
            const sortedData = data.sort((a, b) => b.completion_rate - a.completion_rate);
            
            tbody.innerHTML = sortedData.map(rider => {
                const status = getRiderStatus(rider);
                return `
                <tr>
                    <td>${rider.rider_name}</td>
                    <td>${rider.completion_rate}%</td>
                    <td>${rider.on_time_rate}%</td>
                    <td>${rider.orders_per_hour}</td>
                    <td class="status-${status}">${getStatusText(status)}</td>
                </tr>`;
            }).join('');
        }

        // æ˜¾ç¤ºç«™ç‚¹è¯¦æƒ…
        function showSiteDetail(siteId) {
            const site = mockData.sites.find(s => s.site_id === siteId);
            const riders = mockData.riders.filter(r => r.rider_name.includes(siteId.replace('site_', '').toUpperCase()));
            
            let detailHtml = `
                <div style="background: white; padding: 20px; border-radius: 10px; max-width: 800px;">
                    <h3 style="color: #1890ff;">ğŸ“ ${site.site_name} è¯¦æƒ…</h3>
                    <p><strong>ç»ç†:</strong> ${site.manager} | <strong>åœ°åŒº:</strong> ${site.region}</p>
                    <div style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead><tr style="background: #f5f5f5;"><th>é…é€å‘˜</th><th>å®Œæˆç‡</th><th>å‡†æ—¶ç‡</th><th>æ—¶å‡å•é‡</th><th>å•å‡æˆæœ¬</th></tr></thead>
                            <tbody>`;
            
            riders.forEach(rider => {
                detailHtml += `<tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">${rider.rider_name}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${rider.completion_rate}%</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${rider.on_time_rate}%</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${rider.orders_per_hour}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">$${rider.cost_per_order}</td>
                </tr>`;
            });
            
            detailHtml += `</tbody></table></div>
                    <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 15px; padding: 8px 16px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer;">å…³é—­</button>
                </div>`;
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;';
            modal.innerHTML = detailHtml;
            modal.onclick = (e) => { if(e.target === modal) modal.remove(); };
            document.body.appendChild(modal);
        }

        // æ˜¾ç¤ºæŠ€æœ¯æ ˆ
        function showTechStack() {
            alert('æŠ€æœ¯æ ˆï¼š\n\nå‰ç«¯ï¼šHTML + CSS + JavaScript + Chart.js\nåç«¯ï¼šPython + FastAPI + SQLite\næ•°æ®åº“ï¼šSQLite\nåŠŸèƒ½ï¼šå®æ—¶KPIç›‘æ§ã€æ•°æ®å¯è§†åŒ–ã€ç«™ç‚¹ç®¡ç†');
        }

        // é¡µé¢åŠ è½½
        window.onload = function() {
            initDates();
            loadSitesList();
            loadData();
        };
    </script>
</body>
</html>